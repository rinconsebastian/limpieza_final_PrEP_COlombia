---
title: "Reporte Final Piloto PrEP Colombia"
author: "OPS, PNUD"
date: "24/6/2021"
output: word_document

---


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE) 
knitr::opts_chunk$set(echo = FALSE)

if(!require(readxl)){
  install.packages("readxl")
  library(readxl)
}

if(!require(dplyr)){
  install.packages("dplyr")
  library(dplyr)
}

if(!require(data.table)){
  install.packages("data.table")
  library(data.table)
}

if(!require(flextable)){
  install.packages("flextable")
  library(flextable)
}

if(!require(janitor)){
  install.packages("janitor")
  library(janitor)
}

#if(!require(rapportools)){
#  install.packages("rapportools")
#  library(rapportools)
#}



set_flextable_defaults(
  font.family = "Arial", 
  font.size = 10,
  font.color = "black",
  table.layout = "fixed",
  digits = 1,
  theme_fun = "theme_box"
  )

#------------------------ LEYENDO ARCHIVOS -------------------------------------
encuestas <- read_excel("data/Encuestas_24-06-2021.xlsx")
orientaciones <- read_excel("data/Orientaciones_24-06-2021.xlsx")
personas <- read_excel("data/Personas_02-07-2021.xlsx")
personasN <- read_excel("data/PersonasNormal_02-07-2021.xlsx")




# Edad de personas a entero
personas <- personas%>%mutate(Edad =as.integer(Edad))
personas <- personas%>%mutate(`Síntomas clamidia form1` = as.factor(`Síntomas clamidia form1`))

# completa los nombres de las columnas de las encuestas
setnames(encuestas, "RelacionesConMas" , '¿En los últimos 6 meses, ha tenido una o más relaciones sexuales sin condón?')
setnames(encuestas, "RelacionesConVih" , '¿En los últimos 6 meses, ha tenido relaciones sexuales con alguna persona que viva con VIH?')
setnames(encuestas, "RelacionesConInyectado" , '¿Ha tenido relaciones sexuales con personas que consumen drogas inyectables, en los últimos 6 meses?')
setnames(encuestas, "HaTenidoIts" , '¿En los últimos 6 meses le han diagnosticado, o ha tenido síntomas recientemente de alguna infección de transmisión sexual?')
setnames(encuestas, "HaUsadoPep" , '¿Ha utilizado, en los últimos 6 meses, PEP o le han indicado la necesidad de utilizar antirretrovirales para prevenir el VIH?')
setnames(encuestas, "HaSidoDiagnosticadoVih" , '¿Ha sido diagnosticado con infección por el VIH o con Sida?')
setnames(encuestas, "HaUsadoPrep" , 'Ha utilizado (ha tomado o toma actualmente) o ha querido utilizar la PrEP?')
setnames(encuestas, "QueTantoSabePrep" , '¿Qué tanto sabe usted de PreP?')
setnames(encuestas, "HaSidoObligado" , '¿Ha tenido relaciones sexuales contra su voluntad, en el último año?')
setnames(encuestas, "HaSufridoAgresiones" , '¿Ha sido Ud. víctima de agresiones físicas o psicológicas, incluidas las agresiones por parte de una pareja sexual, en los últimos 6 meses?')
setnames(encuestas, "ParejaEstaConARV" , '¿Sabe usted si su pareja está tomando tratamiento antirretroviral (TAR) para la infección por el VIH?')
setnames(encuestas, "ParejaHaUsadoARV" , '¿Sabe si su pareja este tomado tratamiento antirretroviral (TAR), lo ha hecho durante los últimos 6 meses?')
setnames(encuestas, "ParejaCargaViral" , '¿sabe si su pareja se ha realizado la Carga Viral en los últimos 6 meses?')
setnames(encuestas, "ParejaIndetectable" , '¿Sabe si el resultado de ese examen fue indetectable?')
encuestas <- encuestas%>%mutate(Poblacion = if_else(Poblacion == "Hombre que tiene sexo con otros hombres","HSH",Poblacion)) #estandariza el  nombre de la población


#LIMPIANDO ENCUESTAS 
encuestas <- encuestas %>% filter(!(is.na(Doc) | Edad <18)) %>%             #filtra encuestas sin cedula 
                     filter(!(is.na(`Fec. Encuesta`) | `Enc. Aprobada` == "No")) %>% #filtra encuestas sin  fecha
                     arrange(desc(`Enc. Aprobada`))%>% #ordena encuestas  por aprobadas y no aprobadas
                     distinct(`Doc`, .keep_all= TRUE)


#LIMPIEZA ORIENTACIONES
orientaciones <- orientaciones %>% filter(!(is.na(`Cédula`))) %>%             #filtra oreintaciones sin cédula
                     filter((Estado == "Atendida")) %>% #filtra encuestas sin  fecha
                     arrange(`Estado`)%>% #ordena encuestas  por aprobadas y no aprobadas
                     distinct(`Cédula`, .keep_all= TRUE)

setnames(orientaciones, "Cédula" , 'Doc')


orientaciones <- merge(x= orientaciones, y= encuestas, by.x = "Doc", by.y = "Doc")  # une citas y encuestas, mantiene todas las citas


rango_edad <- c("(17,19]" ="18-19","(19,24]" ="20-24" ,"(24,49]"="25-49","(49,120]"="≥ 50","Total"="Total" )




# limpieza creatininas form 2
personas <-personas%>%mutate(`Depuracion Creatinina form2` = gsub(",",".",`Depuracion Creatinina form2` ))%>%
                      mutate(`Depuracion Creatinina form2` = gsub("([aA-zZ]|:| |/)","",`Depuracion Creatinina form2` ))%>%
  mutate(`Depuracion Creatinina form2` = gsub("88397","88.397",`Depuracion Creatinina form2` ))%>%
                      mutate(`Depuracion Creatinina form2` = as.numeric(`Depuracion Creatinina form2`))%>%
                      mutate(`Alteración decreatinina form2` = as.factor(if_else(`Depuracion Creatinina form2`>= 60 ,F,T )))


# limpieza creatininas form 2
personas <-personas%>%mutate(`Depuracion Creatinina form3` = gsub(",",".",`Depuracion Creatinina form3` ))%>%
                      mutate(`Depuracion Creatinina form3` = gsub("([aA-zZ]|:| |/)","",`Depuracion Creatinina form3` ))%>%
                      mutate(`Depuracion Creatinina form3` = as.numeric(`Depuracion Creatinina form3`))%>%
                      mutate(`Alteración decreatinina form3` = as.factor(if_else(`Depuracion Creatinina form3`>= 60 ,F,T )))

# limpieza creatininas form 3
personas <-personas%>%mutate(`Depuracion Creatinina form3-2` = gsub(",",".",`Depuracion Creatinina form3-2` ))%>%
                      mutate(`Depuracion Creatinina form3-2` = gsub("([aA-zZ]|:| |/)","",`Depuracion Creatinina form3-2` ))%>%
                      mutate(`Depuracion Creatinina form3-2` = as.numeric(`Depuracion Creatinina form3`))%>%
                      mutate(`Alteración decreatinina form3-2` = as.factor(if_else(`Depuracion Creatinina form3-2`>= 60 ,F,T )))


#cambio en el nombre de os formularios
personasN <- personasN%>%mutate(Formulario = if_else(Formulario == "Formulario inicial", "Cita de ingreso al programa", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Control 30 dias", "Primera cita de control", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Trimestral 1", "Segunda cita de control", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Trimestral 2", "Tercera cita de control", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Trimestral 3", "Cuarta cita de control", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Trimestral 4", "Quinta cita de control", Formulario ))%>%
                         mutate(Formulario = if_else(Formulario == "Cierre", "Cita de cierre", Formulario ))
  


```
## B.	Análisis general de seguimiento a la cohorte
### 1.	Adherencia al programa

    
**Numerador:** número y porcentaje de usuarios que asistieron a cada uno de los controles, por cita programada y brazo de atención

```{r  echo=FALSE,warning = FALSE}
numerador <- personasN%>%filter(`Variable` == "Medico")%>%
                             group_by(`Formulario`=Formulario,`Brazo` =  Brazo) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(Formulario)%>%
                             as.data.table()%>%
                             dcast(`Brazo` ~ Formulario, fun.aggregate = sum, value.var = "num")%>%
                             adorn_totals("row")%>%
                             melt(id="Brazo")%>%
                             dcast(variable ~ `Brazo`, fun.aggregate = sum, value.var = "value")


```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/first(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/first(SUBSIDIADO))%>%
                           mutate(`num_TOTAL` =100*Total/first(Total))%>%
                           select(1,2,5,4,6,3,7)%>%
                          slice(2,4,6,7,3,1) 
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("variable", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Total","num_TOTAL" ),
      line2 = c("Atención", rep("Particular",2), rep("Subsidiado",2), 
                rep("Total",2)),
      line3 = c("Atención", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_TOTAL` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Adherencia al programa, por brazo de atención")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
*El formulario de cierre se diligenció tanto para las personas que terminaron el piloto de manera completa, como para las que se retiraron o abandonaron el programa.*

#### 1.1 Tiempos promedio entre atenciones
```{r  echo=FALSE,warning = FALSE}
numerador <- personas%>%select(`Doc`,`Fec. Formulario 1`,`Fec. Formulario 2`,`Fec. Formulario 3`,`Fec. Formulario 3-2`,`Fec. Formulario 3-3`,`Fec. Form cierre`)%>%
                        mutate(t1 = as.double(`Fec. Formulario 2`-`Fec. Formulario 1`))%>%
                        mutate(t2 = as.double(`Fec. Formulario 3`-`Fec. Formulario 2`))%>%
                        mutate(t3 = as.double(`Fec. Formulario 3-2`-`Fec. Formulario 3`))%>%
                        mutate(t4 = as.double(`Fec. Formulario 3-3`-`Fec. Formulario 3-2`))%>%
                        mutate(t5 = as.double(difftime( `Fec. Form cierre`,`Fec. Formulario 3-3`, units = "days") ))%>%
                        mutate(t1 = if_else(t1<0,0,t1))%>%
                        mutate(t2 = if_else(t2<0,0,t2))%>%
                        mutate(t3 = if_else(t3<0,0,t3))%>%
                        mutate(t4 = if_else(t4<0,0,t4))%>%
                        mutate(t5 = if_else(t5<0,0,t5))%>%
                        select(t1,t2,t3,t4,t5)%>%
                        summarise(across(everything(), list(Promedio=mean), na.rm = TRUE))%>%#`Mínimo` = min,Promedio=mean, `Máximo` = max), na.rm = TRUE))%>%
                        as.data.table()%>%
                        melt()%>%
                        tidyr::separate(variable,c("periodo","calculo"),"_")%>%
                        as.data.table()%>%
                        dcast(calculo ~ `periodo` )%>%
                        slice(2,3,1)
              
```
```{r  echo=FALSE,warning = FALSE}
      result <-  numerador
      
            header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("calculo", "t1", "t2", "t3", 
                   "t4", "t5"),
      line2 = c("Tiempo entre cada atención", "Cita de ingreso","Primera cita de control","Segunda cita de control","Tercera cita de contro","Cuarta cita de contro"),
      line3 = c("Tiempo entre cada atención","Primera cita de control","Segunda cita de control","Tercera cita de control","Cuarta cita de contro","Cita de cierre"))
            
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,t1 = function(x) ifelse(is.na(x),"_",sprintf("%.02f",x))) # da formato %  
      ft <- set_formatter( x = ft,`t2` = function(x) ifelse(is.na(x),"_",sprintf("%.02f",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`t3` = function(x) ifelse(is.na(x),"_",sprintf("%.02f",x)))# da formato %  a columan de resultados
      ft <- set_formatter( x = ft,`t4` = function(x) ifelse(is.na(x),"_",sprintf("%.02f",x)))# da formato %  a columan de resultados
      ft <- set_formatter( x = ft,`t5` = function(x) ifelse(is.na(x),"_",sprintf("%.02f",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Tiempo promedio transcurrido entre las citas programadas de seguimiento")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```

### 2.	Cierres, retiros y abandonos
#### 2.1	Número y porcentaje de usuarios que cumplieron el seguimiento completo (cierre) y de usuarios que se retiraron o abandonaron el programa, por brazo de atención
 
```{r  echo=FALSE,warning = FALSE}
numerador <- personasN%>%filter(`Variable` == "tipo_cierre")%>%
                             group_by(`Valor`=Valor,`Brazo` =  Brazo) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             as.data.table()%>%
                             dcast(`Valor` ~ Brazo, fun.aggregate = sum, value.var = "num")%>%
                             mutate(Todos = PARTICULAR + SUBSIDIADO)%>%
                             adorn_totals("row")

```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/last(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/last(SUBSIDIADO))%>%
                           mutate(`num_Todos` =100*Todos/last(Todos))%>%
                           select(1,2,5,3,6,4,7)%>%
                           slice(2,3,1,4)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Valor", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Todos","num_Todos" ),
      line2 = c("Estado final", rep("Particular",2), rep("Subsidiado",2), 
                rep("Todos",2)),
      line3 = c("Estado final", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_Todos` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que cumplieron el seguimiento completo (cierre) y de usuarios que se retiraron o abandonaron el programa, por brazo de atención")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```




#### 2.2  Número y porcentaje de personas que se retiraron del programa piloto por causa y brazo
**Numerador:** número y porcentaje de personas que se retiraron del programa piloto, por causa y brazo

```{r  echo=FALSE,warning = FALSE}
numerador <- personasN%>%filter(`Variable` == "tipo_cierre" | Variable == "tipo_cierre_abandono")%>%
                          select(Doc,Brazo,Variable,Valor)%>%
                          as.data.table() %>% 
                          dcast(Doc+ Brazo ~ `Variable`, value.var = "Valor")%>%
                          filter(tipo_cierre == "Retiro")%>%
                          select(-tipo_cierre)%>%
                          dcast(`tipo_cierre_abandono` ~ Brazo, fun.aggregate = length)%>%
                          mutate(Todos = PARTICULAR + SUBSIDIADO)%>%
                          adorn_totals("row")
```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/last(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/last(SUBSIDIADO))%>%
                           mutate(`num_Todos` =100*Todos/last(Todos))%>%
                           select(1,2,5,3,6,4,7)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("tipo_cierre_abandono", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Todos","num_Todos" ),
      line2 = c("Causa de retiro", rep("Particular",2), rep("Subsidiado",2), 
                rep("Todos",2)),
      line3 = c("Causa de retiro", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_Todos` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Causas de retiro del programa piloto, por brazo ")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```

#### 2.3  Número y porcentaje de personas que abandonaron el programa piloto por causa y brazo
**Numerador:** número y porcentaje de personas que abandonaron el programa piloto, por causa y brazo

```{r  echo=FALSE,warning = FALSE}
numerador <- personasN%>%filter(`Variable` == "tipo_cierre" | Variable == "tipo_cierre_abandono")%>%
                          select(Doc,Brazo,Variable,Valor)%>%
                          as.data.table() %>% 
                          dcast(Doc+ Brazo ~ `Variable`, value.var = "Valor")%>%
                          filter(tipo_cierre == "Abandono")%>%
                          select(-tipo_cierre)%>%
                          dcast(`tipo_cierre_abandono` ~ Brazo, fun.aggregate = length)%>%
                          mutate(Todos = PARTICULAR + SUBSIDIADO)%>%
                          adorn_totals("row")
```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/last(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/last(SUBSIDIADO))%>%
                           mutate(`num_Todos` =100*Todos/last(Todos))%>%
                           select(1,2,5,3,6,4,7)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("tipo_cierre_abandono", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Todos","num_Todos" ),
      line2 = c("Causa de Abandono", rep("Particular",2), rep("Subsidiado",2), 
                rep("Todos",2)),
      line3 = c("Causa de Abandono", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_Todos` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Causas de abandono del programa piloto, por brazo ")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```

### 3.	Adherencia a la PrEP (TAR)
#### 3.1 Usuarios adherentes a la PrEP (TAR)
**Numerador:** número y porcentaje de usuarios que reportaron adherencia de 100% en el último mes (de acuerdo a definición del protocolo)
**Denominador: ** número de personas que asistieron a la cita de control
```{r  echo=FALSE,warning = FALSE}
    
numerador0 <- personasN%>%filter(`Variable` == "pastillas_no_tomadas_prep")%>%
                       mutate(Valor = as.integer(Valor))%>%
                       mutate(Valor = abs(Valor))%>%
                       mutate(adeherente30 = if_else(Valor<=5,"Si","No"))


numerador30 <- numerador0%>%filter(adeherente30 == "Si")%>%
                         group_by(`Formulario`=Formulario ) %>% 
                             summarise(num30= n(), .groups = "keep") %>%
                             arrange(Formulario)%>%
                             as.data.table()



numerador7 <- personasN%>%filter(`Variable` == "pastillas_no_tomadas7_prep")%>%
                       mutate(Valor = as.integer(Valor))%>%
                       mutate(Valor = abs(Valor))%>%
                       mutate(adeherente7 = if_else(Valor<=3,"Si","No"))


numerador7 <- numerador7%>%filter(adeherente7 == "Si")%>%
                         group_by(`Formulario`=Formulario ) %>% 
                             summarise(num7= n(), .groups = "keep") %>%
                             arrange(Formulario)%>%
                             as.data.table()

numerador <- merge(x= numerador30, y= numerador7, by.x ="Formulario", by.y ="Formulario" )  
```
```{r  echo=FALSE,warning = FALSE}
denominador <- personasN%>%filter(`Variable` == "Medico")%>%
                             group_by(`Formulario`=Formulario ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(Formulario)%>%
                             as.data.table()

```
```{r  echo=FALSE,warning = FALSE}
      
      result <-  merge(x= numerador, y= denominador, all.x = TRUE,  #une numerador y denominado
                           by.x = "Formulario", 
                           by.y = "Formulario")


      result <- result %>% mutate(resultado30 = 100* num7/den) #calcula resultado30
      result <- result %>% mutate(resultado7 = 100* num7/den) #calcula resultado30
      result <- result %>% mutate(den7 = den)
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- result %>% select(c(1,3,7,6,2,4,5))
      result <- result %>% slice(c(2,4,5,1))
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Formulario", "num7", "den7","resultado7", "num30", "den","resultado30" ),
      line2 = c("Atención", rep("Adherencia Semanal",3), rep("Adherencia Mensual",3)),
      line3 = c("Atención", rep(c("num","den","%"),2)))
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,resultado30 = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,resultado7 = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que reportaron adherencia 100% (de acuerdo a definición del protocolo)")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```


#### 3.2 Usuarios no adherentes a la PrEP (TAR)

**Numerador:** Número y % de personas que fueron clasificadas como no adherentes agrupadas por causas de perdida de adherencial y Atención
  
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personasN%>%filter(`Variable` == "pastillas_no_tomadas_prep" | Variable == "motivo_no_tomar_prep")%>%
                          select(Doc,Formulario,Variable,Valor)%>%
                          as.data.table() %>% 
                          dcast(Doc+ Formulario ~ `Variable`, value.var = "Valor")%>%  #convierte en tabla horizontal
                          mutate(pastillas_no_tomadas_prep = as.integer(pastillas_no_tomadas_prep))%>%
                          mutate(adherente30 = if_else(pastillas_no_tomadas_prep<=5,"Si","No"))%>%
                          filter(adherente30 == "No")%>%
                          select(-pastillas_no_tomadas_prep)%>% 
                          mutate(motivo_no_tomar_prep = if_else(is.na(motivo_no_tomar_prep),"Otro",motivo_no_tomar_prep))%>%
                          dcast(`motivo_no_tomar_prep` ~ Formulario, fun.aggregate = length, value.var = "adherente30")%>%
                          adorn_totals("row")
 
```

```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>% mutate(`res_Control 30 dias` = 100* `Primera cita de control`/sum(`Primera cita de control`/2)) #calcula resultado c30
      result <- result %>% mutate(`res_Trimestral 1` = 100* `Segunda cita de control`/sum(`Segunda cita de control`/2)) #calcula resultado T1
      result <- result %>% mutate(`res_Trimestral 2` = 100* `Tercera cita de control`/sum(`Segunda cita de control`/2)) #calcula resultado T1
      result <- result %>% mutate(`res_Trimestral 3` = 100* `Cuarta cita de control`/sum(`Cuarta cita de control`/2)) #calcula resultado T1
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- result %>% select(c(1,3,7,5,8,6,9,2,10))
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("motivo_no_tomar_prep", "Primera cita de control", "res_Control 30 dias",
                   "Segunda cita de control", "res_Trimestral 1", "Tercera cita de control","res_Trimestral 2",
                   "Cuarta cita de control","res_Trimestral 3"  ),
      line2 = c("Motivo", rep("Primera cita de control",2), rep("Segunda cita de control",2), 
                rep("Tercera cita de control",2), rep("Cuarta cita de control",2)),
      line3 = c("Motivo", rep(c("Frec.","%"),4)))
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`res_Control 30 dias` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`res_Trimestral 1` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`res_Trimestral 2` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`res_Trimestral 3` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`res_Trimestral 4` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = ". Número y porcentaje de usuarios que fueron clasificados como no adherentes, agrupadas por causas de pérdida de adherencia y cita de control")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```




### 4.  Reactividad y síntomas de ITS diferentes a VIH
#### 4.a	Pruebas reactivas o reporte de síntomas de ITS diferentes a VIH al ingreso del programa 
La información para esta gráfica la encuentra en los indicadores dela sección C.1.b

#### 4.a-b Detección de alguna ITS diferente a VIH durante el seguimiento del programa

```{r  echo=FALSE,warning = FALSE}

numerador0 <- personasN%>%filter( Variable == "Prueba_rapida_Sifilis" & !is.na(Valor))%>%
                          mutate(Valorn = if_else((Valor == "Reactiva") |(Valor == "Si")  ,1,0))%>%
                          select(Doc,Formulario,Valorn)%>%
                          as.data.table() %>% 
                          dcast(`Doc` ~ Formulario, value.var = "Valorn",fun.aggregate = sum)%>%
                          filter(!(`Cita de ingreso al programa` > 0))%>%
                          select(-Doc)%>%
                          mutate (alguna = rowSums(across(where(is.numeric))))%>%
                          select(alguna)

max1 <- function(x) {
  if_else(x >= 1, 1,0)
}

numerador0 <- numerador0%>% mutate(across(everything(), ~ max1(.x)))%>%
                          summarise(across(everything(), list(Suma=sum), na.rm = TRUE))%>%
                          as.data.table() %>% 
                          melt()
                         
```

```{r  echo=FALSE,warning = FALSE}

numerador <- personasN%>%filter(!(Formulario == "Cita de ingreso al programa" ) & 
                                (Variable == "sintomas_clamidia" |
                                    Variable == "sintomas_gonorrea"|
                                    Variable == "Prueba_rapida_Sifilis" |
                                    Variable == "Prueba_rapida_Hepatitis_B"|
                                    Variable == "Prueba_rapida_Hepatitis_C" )&
                                    !(is.na(Valor)))%>%
                          mutate(Valorn = if_else((Valor == "Reactiva") |(Valor == "Si")  ,1,0))%>%
                          select(Doc,Variable,Valorn)%>%
                          as.data.table() %>% 
                          dcast(`Doc` ~ Variable, value.var = "Valorn",fun.aggregate = sum)


numeradorinicial <- personasN%>%filter((Formulario == "Cita de ingreso al programa" ) & 
                                (Variable == "sintomas_clamidia" |
                                    Variable == "sintomas_gonorrea"|
                                    Variable == "Prueba_rapida_Sifilis" |
                                    Variable == "Prueba_rapida_Hepatitis_B"|
                                    Variable == "Prueba_rapida_Hepatitis_C" )&
                                    !(is.na(Valor)))%>%
                          mutate(Valorn = if_else((Valor == "Reactiva") |(Valor == "Si")  ,1,0))%>%
                          select(Doc,Variable,Valorn)%>%
                          as.data.table() %>% 
                          dcast(`Doc` ~ Variable, value.var = "Valorn",fun.aggregate = sum)


numerador1 <- merge(x=numerador, y = numeradorinicial, all.x = TRUE, by.x = "Doc", by.y = "Doc")

numerador1 <- numerador1 %>% mutate(`Prueba_rapida_Sifilis`=`Prueba_rapida_Sifilis.x`&(!`Prueba_rapida_Sifilis.y`))%>%
                             mutate(`Prueba_rapida_Hepatitis_B`=`Prueba_rapida_Hepatitis_B.x`&(!`Prueba_rapida_Hepatitis_B.y`))%>%
                             mutate(`Prueba_rapida_Hepatitis_C`=`Prueba_rapida_Hepatitis_C.x`&(!`Prueba_rapida_Hepatitis_C.y`))%>%
                             mutate(`sintomas_clamidia`=`sintomas_clamidia.x`&(!`sintomas_clamidia.y`))%>%
                             mutate(`sintomas_gonorrea`=`sintomas_gonorrea.x`&(!`sintomas_gonorrea.y`))%>%
                             select(1,12:16)%>%
                             select(-Doc)%>%
                             mutate (alguna = sintomas_clamidia | sintomas_gonorrea | Prueba_rapida_Sifilis|Prueba_rapida_Hepatitis_B|Prueba_rapida_Hepatitis_C)
  
numerador2 <- numerador1%>% summarise(across(everything(), list(Suma=sum), na.rm = TRUE))%>%
                          as.data.table()


numerador2$id <- c("its")
numerador2<- numerador2%>%melt()%>%
                          select(-id)

```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador2 %>%mutate(`resultado` =100*value/count(personas)[[1]])
      
      result$variable = c("Prueba de Sífilis","Prueba Hepatitis B","Prueba Hepatitis C", "Síntomas de Clamidia","Síntomas de Gonorrea", "Alguna ITS" )

      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("variable", "value", "resultado"),
      line2 = c("ITS", rep("Frecuencia",1), rep("%",1)))    
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que a las que se les detectó alguna ITS diferente a VIH
durante el seguimiento del programa piloto PrEP")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```


## C.	Indicadores de Monitoreo PrEP
### 1. Captación de la población blanco (PrEP uptake    
#### a Indicador clave   
**Numerador:** Número de personas que iniciaron PrEP en los últimos 12 meses.  
  
**Denominador:** número de personas a los que se les ofreció "de novo" la PrEP en los últimos 12 meses*  
  
*El denominador corresponde a las personas que, una vez respondida la encuesta en línea, se clasificaron como personas en riesgo.*
  

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- encuestas %>% filter(!(is.na(Doc) | Edad <18)) %>%             #filtra encuestas sin cedula 
                     filter(!(is.na(`Fec. Encuesta`) | `Enc. Aprobada` == "No")) %>% #filtra encuestas sin  fecha
                     arrange(desc(`Enc. Aprobada`))%>% #ordena encuestas  por aprobadas y no aprobadas
                     distinct(`Doc`, .keep_all= TRUE)%>% #elimina encuestas con cedula repetida
                     group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% # 18-19 , 20-24 25-49 50-120
                     summarise(den= n(), .groups = "keep") %>%
                     arrange(as.numeric(`Población`))%>%
                     as.data.table()%>%
                     dcast(Rango ~ `Población`, fun.aggregate = sum, value.var="den" )%>%
                     adorn_totals("row")%>%
                     mutate(`Todos` = `HSH`+`Mujer trans`)%>%
                     melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas elegibles que iniciaron PrEP oral, por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```



#### b Indicadores secundarios
##### 1.	Número y porcentaje de personas que respondieron la encuesta en línea y obtuvieron una cita con el orientador comunitario
**Numerador:** número de personas que tuvieron cita de asesoría con el orientador comunitario..  
  
**Denominador:** número de personas a los que se les ofreció “de novo” la PrEP en los últimos 12 meses*

*El denominador corresponde a las personas que, una vez respondida la encuesta en línea, se clasificaron como personas en riesgo.  
   

```{r  echo=FALSE,warning = FALSE}
    
numerador <- orientaciones%>%
                     group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                     summarise(num= n(), .groups = "keep") %>%
                     arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- encuestas%>% #elimina encuestas con cedula repetida
                     distinct(`Doc`, .keep_all= TRUE)%>% #elimina encuestas con cedula repetida
                     group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% # 18-19 , 20-24 25-49 50-120
                     summarise(den= n(), .groups = "keep") %>%
                     arrange(as.numeric(`Población`))%>%
                     as.data.table()%>%
                     dcast(Rango ~ `Población`, fun.aggregate = sum, value.var="den" )%>%
                     adorn_totals("row")%>%
                     mutate(`Todos` = `HSH`+`Mujer trans`)%>%
                     melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "Resultado"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número de personas que respondieron la encuesta y obtuvieron una cita con el educador comunitario, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```




##### 2.	Número y porcentaje de personas que tuvieron una cita con el orientador comunitario y que pasaron a cita médica    
**Numerador:** número de personas que iniciaron PrEP en los últimos 12 meses. 
  
**Denominador:** número de personas que obtuvieron cita de asesoría.
  
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- orientaciones%>%
                     group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                     summarise(den= n(), .groups = "keep") %>%
                     arrange(as.numeric(Rango))%>%
                     as.data.table()%>%
                     dcast(Rango ~ `Población`, fun.aggregate = sum, value.var="den" )%>%
                     adorn_totals("row")%>%
                     mutate(`Todos` = `HSH`+`Mujer trans`)%>%
                     melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "Resultado"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que tuvieron una cita con el orientador comunitario y que pasaron a cita médica, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
  




##### 3.	Número de usuarios incluidos en el programa de PrEP oral
###### 3.1. Número de usuarios incluidos en el programa de PrEP oral, por población y rango de edad
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```

```{r  echo=FALSE,warning = FALSE}
      result <- as.data.table(numerador) 
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      result <- result %>% mutate(HSH_resultado =  100*HSH_num/sum(HSH_num/2))
      result <- result %>% mutate(`Mujer trans_resultado` =  100*`Mujer trans_num`/sum(`Mujer trans_num`/2))
      result <- result %>% mutate(`Todos_resultado` =  100*`Todos_num`/sum(`Todos_num`/2))
      result <- result %>% relocate(`Rango`,`HSH_num`,`HSH_resultado`,`Mujer trans_num`,`Mujer trans_resultado`,`Todos_num`,`Todos_resultado`)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_resultado",
                   "Todos_num", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 2), rep("Mujer Trans", 2), rep("Todos", 2)),
      line3 = c("Rango Edad", rep(c("Frecuencia",  "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número de usuarios incluidos en el programa de PrEP oral, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
###### 3.2. Número de usuarios incluidos en el programa de PrEP oral, por institución y brazo de atención
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%group_by(`Brazo`=`Brazo 1`, `Institución`= `Centro 1` ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Institución))%>%
                             as.data.table()%>%
                             dcast(Brazo ~ `Institución`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `Profamilia`+`SIES` )%>%
                             melt( id="Brazo" )

setnames(numerador, "variable" , 'Institución')
setnames(numerador, "value" , 'num')
```

```{r  echo=FALSE,warning = FALSE}
      result <- as.data.table(numerador) 
      result <- melt(result, id=c("Brazo","Institución") ) #convierte en tabla vertica
      result <- dcast(result, Brazo ~ `Institución`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      
      result <- result %>% mutate(Profamilia_resultado =  100*Profamilia_num/sum(Profamilia_num/2))
      result <- result %>% mutate(`SIES_resultado` =  100*`SIES_num`/sum(`SIES_num`/2))
      result <- result %>% mutate(`Todos_resultado` =  100*`Todos_num`/sum(`Todos_num`/2))
      result <- result %>% relocate(`Brazo`,`Profamilia_num`,`Profamilia_resultado`,`SIES_num`,`SIES_resultado`,`Todos_num`,`Todos_resultado`)
      
     result <- result %>% mutate(Brazo =  if_else(Brazo == "PARTICULAR","Particular", Brazo))
     result <- result %>% mutate(Brazo =  if_else(Brazo == "SUBSIDIADO","Subsidiado", Brazo))
     
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Brazo", "Profamilia_num", "Profamilia_resultado", 
                   "SIES_num", "SIES_resultado",
                   "Todos_num", "Todos_resultado"),
      line2 = c("Brazo", rep("Profamilia", 2), rep("SIES", 2), rep("Todos", 2)),
      line3 = c("Brazo", rep(c("Frecuencia",  "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,Profamilia_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`SIES_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número de usuarios incluidos en el programa de PrEP oral, por institución y brazo de atención")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
##### 4.	Número y porcentaje de usuarios que tuvieron algún resultado patológico de ITS en la consulta médica de ingreso al programa
**Numerador:** número de usuarios que tuvieron algún resultado patológico de ITS en la consulta médica de ingreso al programa
**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral

###### 4.1. Sífilis

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis Form1` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba Sífilis Form1`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que tuvieron resultado reactivo en la prueba de sífilis en la cita médica de ingreso al programa, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
####### Clasificación de sifilis
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis Form1` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Estadios=`Calisificación Sífilis Form1` ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Estadios))%>%
                             as.data.table()%>%
                             dcast(Estadios ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Estadios" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```

```{r  echo=FALSE,warning = FALSE}
      result <- as.data.table(numerador) 
      result <- melt(result, id=c("Estadios","Población") ) #convierte en tabla vertica
      result <- dcast(result, Estadios ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
     
      result <- result %>% mutate(HSH_resultado =  100*HSH_num/sum(HSH_num/2))
      result <- result %>% mutate(`Mujer trans_resultado` =  100*`Mujer trans_num`/sum(`Mujer trans_num`/2))
      result <- result %>% mutate(`Todos_resultado` =  100*`Todos_num`/sum(`Todos_num`/2))
      result <- result %>% relocate(`Estadios`,`HSH_num`,`HSH_resultado`,`Mujer trans_num`,`Mujer trans_resultado`,`Todos_num`,`Todos_resultado`)
      result <- result %>% slice(3,1,2,4)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Estadios", "HSH_num", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_resultado",
                   "Todos_num", "Todos_resultado"),
      line2 = c("Estadios", rep("HSH", 2), rep("Mujer Trans", 2), rep("Todos", 2)),
      line3 = c("Estadios", rep(c("Frecuencia",  "%"), 3)))
   
      
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de pruebas de Sífilis reactivas por estadio y población")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
*La categoría Latente agrupa latente temprana y latente tardía*

###### 4.2. Hepatitis B
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Hepatitis B Form1` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba Hepatitis B Form1`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = FALSE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
     # ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de personas que en la primera consulta tuvieron resultado reactivo en la Prueba de Hepatitis B por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      #ft
```
Se identificó un (`r numerador$num[4]`) caso de con prueba reactiva para Hepatitis B en la cita médica de ingreso (¡OJO!!!! Definir qué prueba fue la que se realizó (Ag, IgM, IgG, etc....). No se muestra una tabla de desagregación.

###### 4.3. Hepatitis C
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Hepatitis C Form1` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba Hepatitis C Form1`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de personas que en la primera consulta tuvieron resultado reactivo en la Prueba de Hepatitis C por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      #ft
```
Se identificaron sei (`r numerador$num[6]`) casos de Hepatitis C en la cita médica de ingreso (¡OJO!!!! Definir qué prueba fue la que se realizó (Ag, IgM, IgG, etc....). No se muestra una tabla de desagregación.
   
    
###### 4.4. Síntomas de Clamidia

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas clamidia form1` == "Sí")%>% count()

```

debido a que no se identificó ningun ( `r numerador`) reporte de sintomas de Clamidia en el formulario inicial, no se muestra tabla 
    
###### 4.5 Síntomas de Gonorrea

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas Gonorrea form1` == "Sí")%>% count()

```
debido a que no se identificó ningun (`r numerador`) reporte de sintomas de Gonorrea en el formulario inicial, no se muestra tabla 
   

   
   
##### 5.	Número y porcentaje de personas que asistieron a la primera cita de control

**Numerador:** número de usuarios que asistieron a la primera cita de control. 

**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral. 
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Formulario 2`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```

```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que asistieron a la primera cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```






*la tabla de tiempos es una parte de la tabla de tiempos de la scción B.1.1.*

##### 6.	Número y porcentaje de personas que tuvieron alteración de alguno de sus exámenes durante la primera cita de control (Tasa de Filtración Glomerular y prueba de VIH)
**Numerador:** número de usuarios que tuvieron alteración de alguno de sus exámenes en la primera cita de control (se calcula individual por cada examen o patología)
**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral

###### 6.1. Reactividad a VIH primer mes   

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba VIH form2` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba VIH form2`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = FALSE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
     # ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de personas que en la consulta del primer mes tuvieron resultado reactivo en la Prueba VIH, por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      #ft
```

Se detectaron `r numerador$num[6]` casos reactivos para VIH en la cita de control del primer mes. Estos casos se describen y analizan en la sección cuatro (4) de los indicadores de monitoreo, “4. Positividad de VIH entre las personas en PrEP”. 


###### 6.2.	Alteración de la Tasa de Filtración Glomerular (TFG) en la primera cita de control

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Alteración decreatinina form2` == TRUE)%>%count()
                             
```

No se presentaron casos de alteración de la Tasa de Filtración Glomerular (TFG) en la primera cita de control.


### 2.	Adherencia temprana (early continuation on PrEP)
#### a	Indicador clave 

**Numerador:** Número de personas que continuaron PrEP en por 3 meses consecutivos después de haber inicidado PrEP en los últimos 12 meses  
  
**Denominador:** Número de personas que iniciaron PrEP oral en los últimos 12 meses
 
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Formulario 3`))%>%
                             group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- personas%>%group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número de usuarios que continuaron la PrEP oral por 3 meses, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
   
   
   
   
   
   
   
#### b Indicadores secundarios   
##### 1 Número y porcentaje de personas que asistieron a la segunda consulta de control
**Numerador:** número de usuarios que asistieron a la segunda cita de control  
  
**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral
 
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Formulario 3`))%>%
                             group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- personas%>%group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que asistieron a la segunda cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```   


##### 2 Número y porcentaje de personas que tuvieron alteración de alguno de sus exámenes de control durante la segunda cita de control 
**Numerador:** número de usuarios que tuvieron alteración de alguno de sus exámenes en la segunda cita de control (se calcula individual por cada examen o patología) 

**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral

###### 2.1. Reactividad a VIH en la segunda cita de control   

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Prueba VIH form3`) & (`Prueba VIH form3` == "Reactiva"))%>%count()
                             
```

```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba VIH form3`) & !(`Prueba VIH form3` == "No se realiza por fuerza mayor"))%>%count()
                             
```
   
No se detalla tabla de desagregacion ya que de las **`r denominador`** pruebas realizadas solo hubo **`r numerador`** reactiva.

###### 2.2. Alteración de la Tasa de Filtración Glomerular (TFG) en la segunda cita de control
   
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Alteración decreatinina form3` == TRUE)%>%count()
                             
```

No se presentaron casos de alteración de la Tasa de Filtración Glomerular (TFG) en la segunda cita de control.
   
###### 2.3. Sífilis

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis form3` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba Sífilis form3`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que tuvieron resultado reactivo de sífilis en la segunda cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
####### Clasificación de sifilis
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis form3` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Estadios=`Calisificación Sífilis Form3` ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Estadios))%>%
                             as.data.table()%>%
                             dcast(Estadios ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Estadios" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
``` 

```{r  echo=FALSE,warning = FALSE}
      result <- as.data.table(numerador) 
      result <- melt(result, id=c("Estadios","Población") ) #convierte en tabla vertica
      result <- dcast(result, Estadios ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
     
      result <- result %>% mutate(HSH_resultado =  100*HSH_num/sum(HSH_num/2))
      result <- result %>% mutate(`Mujer trans_resultado` =  100*`Mujer trans_num`/sum(`Mujer trans_num`/2))
      result <- result %>% mutate(`Todos_resultado` =  100*`Todos_num`/sum(`Todos_num`/2))
      result <- result %>% relocate(`Estadios`,`HSH_num`,`HSH_resultado`,`Mujer trans_num`,`Mujer trans_resultado`,`Todos_num`,`Todos_resultado`)
      result <- result %>% slice(5,3,2,4,1)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Estadios", "HSH_num", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_resultado",
                   "Todos_num", "Todos_resultado"),
      line2 = c("Estadios", rep("HSH", 2), rep("Mujer Trans", 2), rep("Todos", 2)),
      line3 = c("Estadios", rep(c("Frec.",  "%"), 3)))
   
      
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de pruebas de Sífilis reactivas del tercer mes, por estadio y población")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
    
###### 2.4. Sintomas de Clamidia

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas clamidia form3` == "Si")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Síntomas clamidia form3`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de personas que en consulta del tercer mes reportaron síntomas de Clamidia, por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
###### 2.5 Sintomas de Gonorrea

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas Gonorrea form3` == "Si")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Síntomas Gonorrea form3`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y % de personas que en consulta del tercer mes reportaron síntomas de Gonorrea, por Población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
    
    
##### 3  Número y porcentaje de personas que asistieron a su tercera consulta de control   

**Numerador:** Número de personas que asistieron al tercer control a los 6 meses 
  
**Denominador:** Número de personas que iniciaron PrEP oral en los últimos 12 meses
 
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Formulario 3-2`))%>%
                             group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```


```{r  echo=FALSE,warning = FALSE}
denominador <- personas%>%group_by(`Población`=Poblacion,Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(`Población`))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```
    
        

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador,  all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "Resultado"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "NNúmero y porcentaje de personas que asistieron a su tercera consulta de control, por rango de edad y población")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
   

##### 4  Número y porcentaje de personas que tuvieron alteración de alguno de sus exámenes de control durante la tercera cita de control 
**Numerador:** número de usuarios que tuvieron alteración de alguno de sus exámenes en la tercera cita de control (se calcula individual por cada examen o patología)
**Denominador:** número de usuarios incluidos en el programa piloto de PrEP oral

###### 4.1. Reactividad a VIH en la tercera cita de control   

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(!is.na(`Prueba VIH form3-2`) & (`Prueba VIH form3-2` == "Reactiva"))%>%count()
                             
```

```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba VIH form3-2`) & !(`Prueba VIH form3-2` == "No se realiza por fuerza mayor"))%>%count()
                             
```
Se detectó **`r numerador`** caso reactivo para VIH en la tercera cita de control. Este caso se describe y analiza en la sección cuatro (4) de los indicadores de monitoreo, “4. Positividad de VIH entre las personas en PrEP”.
   

###### 4.2. Alteración de la Tasa de Filtración Glomerular (TFG) en la tercera cita de control    
   
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Alteración decreatinina form3-2` == TRUE)%>%count()
                             
```

No se presentaron casos de alteración de la Tasa de Filtración Glomerular (TFG) en la tercera cita de control. 
   
###### 4.4. Sífilis

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis form3-2` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Prueba Sífilis form3-2`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que tuvieron resultado reactivo de sífilis en la tercera cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
####### Clasificación de sifilis
```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Prueba Sífilis form3-2` == "Reactiva")%>%
                             group_by(`Población`=Poblacion, Estadios=`Calisificación Sífilis form3-2` ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Estadios))%>%
                             as.data.table()%>%
                             dcast(Estadios ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Estadios" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
``` 

```{r  echo=FALSE,warning = FALSE}
      result <- as.data.table(numerador) 
      result <- melt(result, id=c("Estadios","Población") ) #convierte en tabla vertica
      result <- dcast(result, Estadios ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
     
      result <- result %>% mutate(HSH_resultado =  100*HSH_num/sum(HSH_num/2))
      result <- result %>% mutate(`Mujer trans_resultado` =  100*`Mujer trans_num`/sum(`Mujer trans_num`/2))
      result <- result %>% mutate(`Todos_resultado` =  100*`Todos_num`/sum(`Todos_num`/2))
      result <- result %>% relocate(`Estadios`,`HSH_num`,`HSH_resultado`,`Mujer trans_num`,`Mujer trans_resultado`,`Todos_num`,`Todos_resultado`)
      result <- result %>% slice(5,3,2,4,1)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Estadios", "HSH_num", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_resultado",
                   "Todos_num", "Todos_resultado"),
      line2 = c("Estadios", rep("HSH", 2), rep("Mujer Trans", 2), rep("Todos", 2)),
      line3 = c("Estadios", rep(c("Frec.",  "%"), 3)))
   
      
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Clasificación clínica de sífilis de los usuarios con reactividad en la tercera cita de control")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
    
###### 4.5. Sintomas de Clamidia

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas clamidia form3-2` == "Si")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Síntomas clamidia form3-2`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de usuarios que reportaron síntomas de clamidia en la tercera cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
###### 4.6. Sintomas de Gonorrea

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Síntomas Gonorrea form3-2` == "Si")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%filter(!is.na(`Síntomas Gonorrea form3-2`))%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que reportaron síntomas de gonorrea en la tercera cita de control, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
    



### 3.	Prevalencia de toxicidad (toxicity prevalence among people who have been prescribed PrEP)    
    
#### a Indicador clave    
   
**Numerador:** número de personas que recibieron PrEP y descontinuaron o interrumpieron PrEP debido a toxicidad grave relacionada a la TAR en los últimos 12 meses
**Denominador:** número de personas que recibieron PrEP oral al menos una vez en los últimos 12 meses


```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Tipo abandono retiro form 5` == "Efectos adversos con criterio clínico")%>%count()
                             
```

No se detectaron individuos con efectos adversos graves asociados a la TAR, que cumplieran criterio clínico para interrumpir la PrEP
  
#### b Indicadores secundarios   
##### 1.	Número y porcentaje de usuarios que reportaron efectos adversos asociados a la PrEP

**Numerador:** número de personas que reportaron el efecto adverso 
**Denominador:** número de personas que recibieron PrEP oral al menos una vez en los últimos 12 meses

```{r  echo=FALSE,warning = FALSE}
    
numerador0 <- personasN%>%filter(`Variable` == "efectos_adversos_prep")%>%
                       mutate(Valor = gsub("molestia_relacionada_uso_prep_form3-","",Valor ))%>%
                       mutate(Valor = gsub("Si ","",Valor ))%>%
                       mutate(Valor = gsub("_"," ",Valor ))%>%
                       mutate(Valor = gsub("^Flatulencia$","Flatulencias",Valor ))%>%
                       mutate(Valor = gsub("^nauseas$","Nauseas",Valor ))%>%
                       mutate(Valor = gsub("^otro$","Otro",Valor ))%>%
                       mutate(Valor = gsub("molestias","Molestias",Valor ))%>%
                       mutate(Valor = as.factor(Valor))
                       
numerador<- numerador0[!duplicated(numerador0[c(1,10)]),]  #elimina efectos adversos repetidos por persona y efecto

numerador <- numerador%>%filter(!(`Valor` == "No"|is.na("No"))) #elimina los registros de personoas que no tuvieron efectos adversos
                                                     
numerador <- numerador%>%group_by(`Efecto`=Valor ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(num))%>%
                             as.data.table()
## se calcula el total de personas con algun efecto adverso y se agrega al numerador
numerador2<- numerador0[!duplicated(numerador0[c(1)]),] #elimina efectos adversos repetidos por persona
numerador2 <- numerador2%>%filter(!(`Valor` == "No"|is.na("No")))%>%count() #elimina los registros de personoas que no tuvieron efectos adversos
numerador2 <- data.table("Efecto"="Algún efecto","num"=numerador2[[1]])

numerador <- numerador %>%rbind(numerador2) 
```


```{r  echo=FALSE,warning = FALSE}
      
      
      result <- numerador %>% mutate(resultado = 100* num/count(personas)[[1]]) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Efecto", "num", "resultado" ),
      line2 = c("Efecto Adverso", "Frec.", "%" ))
     
      ft <- flextable(result) #crea tabla 
      ft <- set_formatter( x = ft,resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que reportaron efectos adversos")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)            
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
   
*Solo se reporta una vez cada efecto adverso por persona, así lo haya reportado en varias ocasiones durante su seguimiento*

##### 2.	Número y porcentaje de usuarios que decidieron suspender la PrEP por no tolerabilidad a efectos adversos leves

**Numerador:** Número de personas que decidieron suspender la PrEP por no tolerabilidad a efectos adversos leves
**Denominador:** Número de personas que recibieron PrEP oral al menos una vez en los últimos 12 meses

```{r  echo=FALSE,warning = FALSE}
    
numerador <- personas%>%filter(`Tipo abandono retiro form 5` == "No tolerabilidad a efectos adversos leves")%>%
                             group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="num" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`)%>%
                             melt( id="Rango" )

setnames(numerador, "variable" , 'Población')
setnames(numerador, "value" , 'num')
```
```{r  echo=FALSE,warning = FALSE}
    
denominador <- personas%>%group_by(`Población`=Poblacion, Rango=cut(Edad, breaks= c(17,19,24,49,120)) ) %>% 
                             summarise(den= n(), .groups = "keep") %>%
                             arrange(as.numeric(Rango))%>%
                             as.data.table()%>%
                             dcast(Rango ~ `Población`, fun.aggregate = sum , value.var="den" )%>%
                             adorn_totals("row")%>%
                             mutate(`Todos` = `HSH`+`Mujer trans` )%>%
                             melt( id="Rango" )

setnames(denominador, "variable" , 'Población')
setnames(denominador, "value" , 'den')
```

```{r  echo=FALSE,warning = FALSE}
      result <-  merge(x= numerador, y= denominador, all.y = TRUE,  #une numerador y denominado
                           by.x = c("Rango","Población"), 
                           by.y = c("Rango","Población"))
      
      result <- result %>% mutate(resultado = 100* num/den) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      result <- melt(result, id=c("Rango","Población") ) #convierte en tabla vertica
      result <- dcast(result, Rango ~ `Población`+variable,  #convierte en tabla horizontal
                          fun.aggregate = sum)
      result <- result%>%mutate(Rango = rango_edad[Rango]) # remplaza nombres de los rangos
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Rango", "HSH_num", "HSH_den", "HSH_resultado", 
                   "Mujer trans_num", "Mujer trans_den", "Mujer trans_resultado",
                   "Todos_num", "Todos_den", "Todos_resultado"),
      line2 = c("Rango Edad", rep("HSH", 3), rep("Mujer Trans", 3), rep("Todos", 3)),
      line3 = c("Rango Edad", rep(c("num", "den", "%"), 3)))
   
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,HSH_resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`Mujer trans_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %   resultados
      ft <- set_formatter( x = ft,`Todos_resultado` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x)))# da formato %  a columan de resultados
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que decidieron suspender la PrEP por no tolerabilidad a efectos adversos leves, por población y rango de edad")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)                                             #combina celdas de cabecera                            
      ft <- merge_h(ft,part = "header", i = 1)                                             #combina celdas de cabecera  
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```


### 4.	Positividad de VIH entre las personas en PrEP (HIV positivity among people who have been prescribed PrEP)      
    
#### a. Indicador clave
**Numerador:** Número de personas que tuvieron un examen de VIH de seguimiento con resultado reactivo entre las personas que recibieron PrEP al menos una vez en los últimos 12 meses
**Denominador:** Número de personas que recibieron PrEP oral al menos una vez en los últimos 12 meses y que tuvieron por lo menos un examen de VIH de seguimiento


```{r  echo=FALSE,warning = FALSE}
    
numerador <- personasN%>%filter(`Variable` == "Prueba_rapida_de_VIH" & Valor == "Reactiva")%>%
                       mutate(Valor = as.factor(Valor))%>%
                       arrange(Fecha)

numerador<- numerador[!duplicated(numerador[c(1)]),]  #elimina reacitvos  repetidos por persona

numerador <- numerador%>%group_by(`Formulario`=Formulario ) %>% 
                             summarise(num= n(), .groups = "keep") %>%
                             arrange(Formulario)%>%
                             as.data.table()%>%
                            adorn_totals("row")
  
```
```{r  echo=FALSE,warning = FALSE}
      
      
      result <- numerador %>% mutate(resultado = 100* num/count(personas)[[1]]) #calcula resultado
      result <- as.data.table(result)         #conviert a data.table para poder hacer melt
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Formulario", "num", "resultado" ),
      line2 = c("Atención", "Frec.", "%" ))
     
      ft <- flextable(result) #crea tabla 
      ft <- set_formatter( x = ft,resultado = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Número y porcentaje de personas que tuvieron un resultado positivo de VIH habiendo recibido PrEP al menos una vez en los últimos 12 meses y que tenían al menos un test de seguimiento de VIH")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)            
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```



## D.	Vacunación contra Hepatitis B   
### 1.	General 
#### a   Antecedente de vacunación hepatitis B
   
**Numerador:** número y porcentaje de usuarios que informaron vacunación previa contra hepatitis B en la primera consulta reportada 
    
```{r  echo=FALSE,warning = FALSE}
numerador <- personasN%>%filter(`Variable` == "antecedente_vacuna_hepatitis_b" )%>%
                          select(Doc,Brazo,Variable,Valor)%>%
                          mutate(Valor = if_else(is.na(Valor),"Esquema completo",Valor))%>% # existia un unico valor nulo a se identificó que tenia el esquema completo, se corrige en bd
                          as.data.table() %>% 
                          dcast(`Valor` ~ Brazo, fun.aggregate = length)%>%
                          mutate(Todos = PARTICULAR + SUBSIDIADO)%>%
                          adorn_totals("row")%>%
                          slice(2,3,4,1,5)
```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/last(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/last(SUBSIDIADO))%>%
                           mutate(`num_Todos` =100*Todos/last(Todos))%>%
                           select(1,2,5,3,6,4,7)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("Valor", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Todos","num_Todos" ),
      line2 = c("Antecedente", rep("Particular",2), rep("Subsidiado",2), 
                rep("Todos",2)),
      line3 = c("Antecedente", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_Todos` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Antecedente de vacunación hepatitis B por brazo y estado")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
#### b Número y porcentaje de personas que recibieron vacunas contra Hepatitis B dentro del programa piloto      

**Numerador:** número y porcentaje de personas vacunadas contra hepatitis B dentro del programa piloto, por número de dosis recibidas y brazo 
    
```{r  echo=FALSE,warning = FALSE}
numerador <- personas%>%select(`Brazo 1`,`estado final vacunación Hep B form 5` ) %>%
                        setDT()%>% 
                        dcast(`estado final vacunación Hep B form 5` ~ `Brazo 1`, fun.aggregate = length)%>%
                        mutate(Todos = PARTICULAR + SUBSIDIADO)%>%
                        slice(6,1,2) %>%
                        adorn_totals("row")
```
```{r  echo=FALSE,warning = FALSE}
     

      result <- numerador %>%mutate(`num_PARTICULAR` =100*PARTICULAR/last(PARTICULAR))%>%
                           mutate(`num_SUBSIDIADO` =100*SUBSIDIADO/last(SUBSIDIADO))%>%
                           mutate(`num_Todos` =100*Todos/last(Todos))%>%
                           select(1,2,5,3,6,4,7)
      
      header <- data.frame(             #define tabla para remplazo de cabeceras        
      col_keys = c("estado final vacunación Hep B form 5", "PARTICULAR", "num_PARTICULAR",
                   "SUBSIDIADO", "num_SUBSIDIADO", "Todos","num_Todos" ),
      line2 = c("Estado final", rep("Particular",2), rep("Subsidiado",2), 
                rep("Todos",2)),
      line3 = c("Estado final", rep(c("Frec.","%"),3)))     
     
      ft <- flextable(result, col_keys = header$col_keys) #crea tabla 
      ft <- set_formatter( x = ft,`num_PARTICULAR` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_SUBSIDIADO` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      ft <- set_formatter( x = ft,`num_Todos` = function(x) ifelse(is.na(x),"_",sprintf("%.02f%%",x))) # da formato %  
      
      
      #ft <- autofit(ft)                                                                 #ajusta el ancho de la tabla
      ft <- set_caption(ft, caption = "Estado final de vacunación hepatitis B por brazo y estado ")      #crea titulo de la tabla
      ft <- set_header_df(ft, mapping = header, key = "col_keys" )                     #mapea las cabeceras definitivas
      ft <- merge_v(ft,part = "header", j = 1)
      ft <- merge_h(ft,part = "header", i = 1)
      ft <- theme_box(ft)                                                                 #aplica tema a tabla                                   
      ft <- align(ft,align = "center", part = "header")                                    #alinea cabeceras al centro
      ft <- bold(ft,bold=TRUE,part = "header")                                             #cabeceras en negrilla
      ft <-set_table_properties(ft, layout = "autofit", width = .8)
      ft
```
